# Corepack 使用指南

## 什么是 Corepack？

Corepack 是 Node.js 内置的包管理器管理工具，可以自动为不同项目使用正确版本的 pnpm、yarn 或 npm。

## 项目配置

### 主项目
- **路径**: `/interface`
- **pnpm 版本**: `10.4.1`

### 子项目
- **路径**: `/interface/xx/my-app`
- **pnpm 版本**: `9.15.0` (示例：使用不同版本)

## 启用 Corepack

### 1. 启用 Corepack（一次性操作）

```bash
# 启用 Corepack
corepack enable

# 或者如果需要管理员权限
sudo corepack enable
```

### 2. 验证配置

```bash
# 在主项目根目录
cd /Users/maniu/Documents/Web/company/stellux/mullet/interface
pnpm --version
# 应该显示: 10.4.1

# 在子项目目录
cd /Users/maniu/Documents/Web/company/stellux/mullet/interface/xx/my-app
pnpm --version
# 应该显示: 9.15.0
```

## 如何为项目设置特定的 pnpm 版本

### 方法 1: 手动编辑 package.json

在项目的 `package.json` 中添加或修改 `packageManager` 字段：

```json
{
  "packageManager": "pnpm@10.4.1"
}
```

### 方法 2: 使用 Corepack 命令

```bash
# 进入项目目录
cd /path/to/your/project

# 设置 pnpm 版本
corepack use pnpm@10.4.1
```

这会自动在 `package.json` 中添加或更新 `packageManager` 字段。

## 常用命令

### 查看当前使用的版本

```bash
pnpm --version
```

### 更新到最新版本

```bash
# 更新到 pnpm 最新稳定版
corepack use pnpm@latest

# 更新到指定版本
corepack use pnpm@10.4.1
```

### 准备特定版本（可选）

```bash
# 预下载特定版本，加快首次使用速度
corepack prepare pnpm@10.4.1 --activate
```

## 工作原理

1. **自动检测**: 当你在项目目录中运行 `pnpm` 命令时，Corepack 会读取 `package.json` 中的 `packageManager` 字段
2. **版本匹配**: Corepack 自动下载并使用指定版本的 pnpm
3. **项目隔离**: 不同项目可以使用不同版本，互不干扰

## 团队协作

### 优势

- ✅ **版本一致性**: 团队成员自动使用相同的 pnpm 版本
- ✅ **无需手动安装**: 不需要全局安装特定版本的 pnpm
- ✅ **多版本支持**: 不同项目可以使用不同版本
- ✅ **CI/CD 友好**: 持续集成环境中自动使用正确版本

### 最佳实践

1. **提交 package.json**: 确保 `packageManager` 字段被提交到版本控制
2. **文档说明**: 在 README 中说明项目使用 Corepack
3. **统一配置**: 团队成员都需要启用 Corepack

## 注意事项

### 如果遇到权限问题

```bash
# macOS/Linux
sudo corepack enable

# 或者使用 nvm 等版本管理器，避免 sudo
```

### 如果 Corepack 未安装

```bash
# Node.js 16.9.0+ 已内置 Corepack
# 如果没有，升级 Node.js 版本

node --version  # 检查 Node.js 版本
```

### 禁用 Corepack（如果需要）

```bash
corepack disable
```

## 故障排除

### 问题：pnpm 版本不对

```bash
# 1. 清除 Corepack 缓存
rm -rf ~/.node/corepack

# 2. 重新启用
corepack enable

# 3. 准备版本
corepack prepare pnpm@10.4.1 --activate
```

### 问题：无法下载 pnpm

```bash
# 检查网络或使用镜像
export COREPACK_NPM_REGISTRY=https://registry.npmmirror.com
corepack enable
```

## 示例场景

### 场景 1: 主项目使用最新稳定版

```bash
cd interface
corepack use pnpm@latest
```

### 场景 2: 旧项目保持旧版本

```bash
cd interface/xx/my-app
corepack use pnpm@9.15.0
```

### 场景 3: 临时使用特定版本

```bash
# 不修改 package.json，临时使用特定版本
npx pnpm@10.0.0 install
```

## 参考资源

- [Corepack 官方文档](https://nodejs.org/api/corepack.html)
- [pnpm 版本列表](https://github.com/pnpm/pnpm/releases)

